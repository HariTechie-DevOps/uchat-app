<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Sign In</title>
<style>
    body { font-family: Arial, sans-serif; background: #f5f5f5; }
    .container { width: 360px; margin: 40px auto; background: #fff; padding: 25px; border-radius: 6px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    h2 { text-align: center; margin-bottom: 20px; }
    label { display: block; margin-top: 12px; font-weight: 600; }
    .input-group { display: flex; }
    select, input { width: 100%; padding: 8px; margin-top: 6px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
    select { width: 35%; margin-right: 6px; }
    .actions { margin-top: 16px; }
    .row { display: flex; justify-content: space-between; align-items: center; font-size: 13px; margin-top: 10px; }
    .row a { color: #007bff; text-decoration: none; font-weight: 600; }
    button { width: 100%; padding: 10px; margin-top: 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 15px; }
    button:disabled { background: #ccc; }
    .signup { margin-top: 14px; text-align: center; font-size: 14px; }
    .signup a { color: #007bff; font-weight: 600; text-decoration: none; }
</style>
</head>
<body>

<div class="container">
    <h2>Sign In</h2>

    <label>Mobile</label>
    <div class="input-group">
        <select id="code">
            <option value="+91">+91</option>
            <option value="+1">+1</option>
            <option value="+44">+44</option>
        </select>
        <input id="mobile" maxlength="15" placeholder="Enter mobile number">
    </div>

    <label>Password</label>
    <input id="password" type="password" placeholder="Enter password">

    <div class="row">
        <label>
            <input type="checkbox" id="rememberMe"> Remember me
        </label>
        <a href="#" onclick="forgotPassword()">Forgot password?</a>
    </div>

    <div class="actions">
        <button id="loginBtn" onclick="login()">Login</button>
    </div>

    <div class="signup">
        Create account? <a href="#" onclick="openSignup()">Sign Up</a>
    </div>
</div>

<script>
const API_BASE = "http://13.233.141.130:8080";
    
    async function submitLogin() {
        const userData = {
                // Note: Your Java DTO uses mobile/password usually, 
                // but if your form uses email, ensure they match!
            email: document.getElementById('email').value,
            password: document.getElementById('password').value
        };

        try {
            const response = await fetch('http://localhost:8080/api/signin', { // Use /api/signin for login
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(userData)
            });

            const result = await response.json();
                
                // Real-world check: In your Java code, SignupResponse has a 'success' boolean
            if(result.success === true) { 
                window.location.href = "chooseyourlanguage.html";
            } else {
                alert("Login Failed: " + result.message);
            }
        } catch (error) {
            console.error("Error connecting to server:", error);
        }
    }

// 1. AUTO-LOGIN: Check for token when the page opens
window.onload = function() {
    const savedToken = localStorage.getItem("userToken");
    if (savedToken) {
        console.log("Found token, attempting auto-login...");
        fetch(`${API_BASE}/api/login-with-token?token=${savedToken}`)
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                alert("Welcome back, " + (data.message || "User"));
                window.location.href = "index.html";
            } else {
                // If token is old/invalid, clear it from browser memory
                localStorage.removeItem("userToken");
            }
        })
        .catch(err => console.log("Auto-login server error."));
    }
};

// 2. MAIN LOGIN FUNCTION
function login() {
    const btn = document.getElementById("loginBtn");
    const mobileOnly = document.getElementById("mobile").value.trim();
    const countryCode = document.getElementById("code").value;
    const mobile = countryCode + mobileOnly;
    const password = document.getElementById("password").value;
    
    // --- STEP 1: Check if the user ticked the box ---
    const rememberMe = document.getElementById("rememberMe").checked;

    if (!mobileOnly || !password) {
        alert("Please enter both mobile and password");
        return;
    }

    btn.disabled = true;
    btn.innerText = "Logging in...";

    fetch(`${API_BASE}/api/signin`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ mobile, password })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            localStorage.setItem("userMobile", mobile);
            // --- STEP 2: Store the token if Remember Me is true ---
            if (rememberMe && data.token) {
                localStorage.setItem("userToken", data.token);
                console.log("Token saved to LocalStorage:", data.token);
            }
            
            alert("Login Successful! Welcome " + (data.message || ""));
            window.location.href = "chooseyourlanguage.html"; 
        } else {
            alert("Login Failed: " + data.message);
            btn.disabled = false;
            btn.innerText = "Login";
        }
    })
    .catch(err => {
        alert("Error: Backend server not reachable.");
        btn.disabled = false;
        btn.innerText = "Login";
    });
}

function resetBtn(btn) {
    btn.disabled = false;
    btn.innerText = "Login";
}

function forgotPassword() { window.location.href = "sendotp.html"; }
function openSignup() { window.location.href = "signup.html"; }
</script>

</body>
</html>
